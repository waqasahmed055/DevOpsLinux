- name: Install NinjaOne Agent on Linux Servers
  hosts: all
  become: yes
  vars:
    ninja_rpm_src: "/tmp/NinjaOne-Agent-LandingZone-MainOffice-LINUXSERVER-x86-64.rpm"
    ninja_rpm_dest: "/tmp/NinjaOne-Agent-LandingZone-MainOffice-LINUXSERVER-x86-64.rpm"

  tasks:

    # ── STEP 1: Verify RPM exists on controller ────────────────────────────────
    - name: Verify RPM exists on Ansible controller
      stat:
        path: "{{ ninja_rpm_src }}"
      register: rpm_file
      delegate_to: localhost
      become: no

    - name: Fail if RPM not found on controller
      fail:
        msg: "RPM file not found on controller at {{ ninja_rpm_src }}"
      when: not rpm_file.stat.exists
      delegate_to: localhost
      become: no

    # ── STEP 2: Check if already installed ────────────────────────────────────
    - name: Check if NinjaOne is already installed
      shell: rpm -qa | grep -i ninjaone
      register: ninja_check
      changed_when: false
      failed_when: false

    - name: Skip if already installed
      meta: end_host
      when: ninja_check.rc == 0

    # ── STEP 3: Copy RPM to target ────────────────────────────────────────────
    - name: Copy NinjaOne RPM to target server
      copy:
        src: "{{ ninja_rpm_src }}"
        dest: "{{ ninja_rpm_dest }}"
        owner: root
        group: root
        mode: '0644'

    # ── STEP 4: Install agent ─────────────────────────────────────────────────
    - name: Install NinjaOne agent RPM
      yum:
        name: "{{ ninja_rpm_dest }}"
        state: present
        disable_gpg_check: yes

    # ── STEP 5: Cleanup RPM from target ───────────────────────────────────────
    - name: Remove RPM file from target
      file:
        path: "{{ ninja_rpm_dest }}"
        state: absent

    # ── STEP 6: Start and enable service ──────────────────────────────────────
    - name: Unmask NinjaOne service (in case it is masked)
      systemd:
        name: ninjarmm-agent
        masked: no

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Start and enable NinjaOne service
      systemd:
        name: ninjarmm-agent
        state: started
        enabled: yes

    - name: Wait for service to stabilize
      pause:
        seconds: 5

    # ── STEP 7: Verify ────────────────────────────────────────────────────────
    - name: Verify installation and service status
      shell: rpm -qa | grep -i ninjaone
      register: final_check
      changed_when: false

    - name: Get service status
      systemd:
        name: ninjarmm-agent
      register: service_status

    - name: Display final status
      debug:
        msg:
          - "Host     : {{ inventory_hostname }}"
          - "Package  : {{ final_check.stdout }}"
          - "Service  : {{ service_status.status.ActiveState }}"
